(function(window,document,undefined){var vidMeUploader=(function(file,options){this.state=0;this.init=function(file,options){if(file instanceof window.File){var defaults={chunk:{position:0,size:1000000,type:file.type},video:{mode:'chunked',size:file.size},events:{onRequestError:function(){console.log('VidMe Invalid Video Size');},uploadCancelled:function(){console.log('VidMe Upload Cancelled');},uploadComplete:function(){console.log('VidMe Upload Completed');},uploadPaused:function(){console.log('VidMe Upload Paused');},progress:function(percent){console.log(percent);}}}
this.settings=this.extend(defaults,options);this.file=file;return this;}};this.extend=function(s,o){for(var p in o){try{if(o[p].constructor===Object)
s[p]=this.extend(s[p],o[p]);else
s[p]=o[p];}catch(e){s[p]=o[p];}}
return s;};this.buildUrl=function(url,params){var paramArray=[];for(var key in params){paramArray.push(encodeURIComponent(key)+'='+ encodeURIComponent(params[key]));}
if(typeof(this.settings.auth)!=='undefined'&&typeof(this.settings.auth.token)!=='undefined')
paramArray.push(this.settings.auth.token);return url+'?'+ paramArray.join('&');}
this.requestVideo=function(callback){var xhr=new XMLHttpRequest,reqUrl='https://api.vid.me/video/request',videoOptions=this.settings.video;reqUrl=this.buildUrl(reqUrl,videoOptions);xhr.open('POST',reqUrl,true);xhr.onload=function(){callback(window.JSON.parse(xhr.responseText));};xhr.send();};this.uploadNextChunk=function(vMUploadStatus){var self=this;if(self.state===1){self.settings.chunk.position=(typeof(vMUploadStatus)===typeof(undefined))?self.settings.chunk.position:vMUploadStatus.upload.size_completed;var xhr=new XMLHttpRequest,blob=self.getBlob(self.settings.chunk.position,(self.settings.chunk.position+ self.settings.chunk.size),self.file.type),chunkProgress=0,reqUrl='https://api.vid.me/upload/chunk';reqUrl=self.buildUrl(reqUrl,{code:self.vMData.code,upload:self.vMData.uploadId});xhr.open('POST',reqUrl,true);xhr.setRequestHeader('Content-Range','bytes '+ self.settings.chunk.position+'-'+((self.settings.chunk.position+ blob.size)- 1)+'/'+ self.file.size);xhr.upload.onprogress=function(e){chunkProgress=((e.loaded/e.total)/ (self.file.size / blob.size)) * 100;
typeof self.settings.events.progress===typeof(Function)&&self.settings.events.progress(Math.floor(self.progress+ chunkProgress));};xhr.onload=function(){var uploadData=window.JSON.parse(xhr.responseText);if(uploadData.status===true){switch(uploadData.upload.state){case'started':self.uploadNextChunk(uploadData);typeof self.settings.events.chunkComplete===typeof(Function)&&self.settings.events.chunkComplete(uploadData);break;case'completed':typeof self.settings.events.uploadComplete===typeof(Function)&&self.settings.events.uploadComplete(uploadData);break;}
self.progress+=chunkProgress;}};xhr.send(blob);}else if(self.state===2){typeof self.settings.events.uploadPaused===typeof(Function)&&self.settings.events.uploadPaused();}};this.uploadCancel=function(callback){var self=this,xhr=new XMLHttpRequest,reqUrl='https://api.vid.me/upload/cancel';reqUrl=self.buildUrl(reqUrl,{code:self.vMData.code,upload:self.vMData.uploadId});xhr.open('POST',reqUrl,true);xhr.onload=function(){var resp=window.JSON.parse(xhr.responseText);if(resp.status===true){typeof self.settings.events.uploadCancelled===typeof(Function)&&self.settings.events.uploadCancelled(resp);}};xhr.send();};this.getBlob=function(start,end,type){return this.file.slice(start,end,type);};if(window===this)
return new vidMeUploader(file,options);if(window.File&&window.FileReader&&window.FileList&&window.Blob)
return this.init(file,options);});vidMeUploader.prototype={upload:function(){var self=this;self.requestVideo(function(response){if(response.status===true){self.vMData=response;self.state=1;self.progress=0;self.uploadNextChunk();return self;}else if(response.status===false){typeof self.settings.events.requestError===typeof(Function)&&self.settings.events.requestError(response);}});return this;},pause:function(){this.state=2;return this;},resume:function(){if(this.state===2){this.state=1;this.uploadNextChunk();}
return this;},cancel:function(){if(this.state==1||this.state==2){this.state=3;this.uploadCancel();}
return this;}};window.vidMeUploader=vidMeUploader;})(window,document);$(function(){$('.postbox-button').tipsy({title:'data-tip',gravity:'e'});$('.postbox-social').tipsy({title:function(){return $(this).data('service')+' Sharing';},gravity:'e'});$('.stream-post .postbox-input').autogrow({vertical:true,horizontal:false});$('.postbox-submit').click(function(){$(this).parents('.post_container').find('form').submit();});$('.postbox-wrapper form').submit(function(e){var form=$(this);var bttn=$(form).find('.postbox-submit');var videoStatus=$(form).find('.postbox-video-status').data('video-status');if(postValidate(this)&&!$(bttn).hasClass('disabled')&&(videoStatus=='inactive'||videoStatus=='complete')){var postData=new FormData($(form)[0]);$(bttn).addClass('disabled').html('<i class="fa fa-refresh fa-spin"></i>');try{var blob=dataURItoBlob($(form).find('.postbox-image').attr('src'));postData.append('files',blob,'image.jpg');}catch(e){}
$.ajax({url:investFeed.base+'post/ajax/new',type:'POST',data:postData,cache:false,contentType:false,processData:false,dataType:'json',success:function(data){if(data.status==true){investFeed.modal.close('.investfeed-modal#post',function(){postReset(form);});}else if(data.status==false){investFeed.modal.close('.investfeed-modal#post',function(){swal(data.error,data.message,'error');$(bttn).removeClass('disabled').text('Post');});}},error:function(){investFeed.modal.close('.investfeed-modal#post',function(){swal('Post Error',"There was an error submitting your post, please wait a moment and try again.",'error');$(bttn).removeClass('disabled').text('Post');});}});}else{if(videoStatus=='rejected'){investFeed.modal.close('.investfeed-modal#post',function(){swal('Video Error',"Your video was rejected, please remove it and try again.",'error');});}else if(videoStatus=='processing'){investFeed.modal.close('.investfeed-modal#post',function(){swal('Video Processing',"Your video is currently processing, please wait a moment, and try again. (Processing can take up to 3 minutes)",'error');});}else if(videoStatus=='uploading'){investFeed.modal.close('.investfeed-modal#post',function(){swal('Video Uploading',"Your video is still uploading. Please wait a moment, and try again.",'error');});}}
e.preventDefault();});function postValidate(form){var errors=[];var content=$(form).find('.postbox-input');if(!($(content).val().length>0))
errors.push([$(form).find('.input-wrapper'),'Your post requires content!']);if(!($(content).val().length<=(parseInt(($(content)).data('post-max'))+ parseInt(($(content)).data('post-offset')))))
errors.push([$(form).find('.input-wrapper'),'Your post is too long!']);if(errors.length==0){return true}else{return false;}}
function postReset(form){$(form).find('.postbox-input, .postbox-symbol, .postbox-upload input').val('');$(form).find('.postbox-actions').show();$(form).find('.postbox-counter span').text($(form).find('.postbox-input').data('post-max'));$(form).find('.postbox-image-preview').hide().find('img').remove();$(form).find('.postbox-submit').text('Post').removeClass('disabled');$(form).find('.postbox-input').attr({style:''});$(form).find('.postbox-video-status').removeClass('success error').find('.video-status-message').html('');$(form).find('.postbox-video-status').find('.video-status-icon').html('');$(form).find('.postbox-video-status').data('video-status','inactive').hide();toggleSliderCenter($(form).find('.postbox-slider'));}
$('.postbox-article').click(function(){var con=$(this).parents('.post_container');if($(con).find('.postbox-input').val().length>0){swal({title:"Unsaved Post",text:"Your post has not been submitted and will be lost when switching to compose and article.",type:"warning",showCancelButton:true,confirmButtonText:'Ok, Compose Article',closeOnConfirm:false},function(){window.document.location=investFeed.base+'article/compose';});}else{window.document.location=investFeed.base+'article/compose';}});$('.postbox-input').on('input change keydown paste',function(){$con=$(this).parents('.post_container');var offset=0;var exurl=/(http|https|ftp|ftps)\:\/\/[a-zA-Z0-9\-\.]+\.[a-zA-Z]{2,3}(\/\S*)?/g;var links=$(this).val().match(exurl);var num=$con.find('.char-count');var limit=$(this).data('post-max');if(jQuery.isEmptyObject(links)==false&&links.length>0){for(i=0;i<links.length;i++){offset+=links[i].length- 23;}}
var len=$(this).val().length- offset;$(this).data('post-offset',offset);$(num).text(limit- len);if(len>limit){$(this).addClass('postbox-input-error');}else if($(this).hasClass('postbox-input-error')){$(this).removeClass('postbox-input-error');}});$('.postbox-preview-close').click(function(){var con=$(this).parents('.post_container');$(con).find('.postbox-actions').show();$(con).find('.postbox-image-preview').hide().find('img').remove();});var vidMeUpload;$('.postbox-upload input').change(function(){var fileInput=$(this);var con=$(this).parents('.post_container');if(this.files&&this.files[0]){var reader=new FileReader();if(this.files[0].type.match('image.*')){$(con).find('.postbox-actions').hide();reader.onload=function(e){var img=$('<img />',{class:'postbox-image',src:e.target.result});$(con).find('.postbox-image-preview').show().append(img);}
reader.readAsDataURL(this.files[0]);}else if(fileAllowed(this.files[0])){$(con).find('.postbox-actions').hide();var fileData=this.files[0];var videoStatus=$(con).find('.postbox-video-status');$(videoStatus).show().find('.video-status-icon').html('<i class="fa fa-cog fa-spin"></i>');$.ajax({url:investFeed.base+'post/vidme/token',type:'GET',cache:false,contentType:false,processData:false,dataType:'json',success:function(token){$(videoStatus).data('video-status','uploading').addClass('uploading').find('.video-status-icon').html('<i class="fa fa-refresh fa-spin"></i>');vidMeUpload=new vidMeUploader(fileData,{video:{token:token.token,private:$(con).find('.post-fees').prop('checked'),description:fileData.name},events:{requestError:function(vMData){investFeed.modal.close('.investfeed-modal#post',function(){swal('VidMe Error',vMData.error,'error');resetVideoUpload(con);});},progress:function(i){$(videoStatus).find('.video-status-message').text(i+'%');},uploadComplete:function(vMData){$(videoStatus).removeClass('uploading').data('video-status','processing').find('.video-status-message').text('Processing');$(videoStatus).find('.video-status-icon').html('<i class="fa fa-cog fa-spin"></i>');$(fileInput).replaceWith($(fileInput).clone(true));$(con).find('form').append('<input type="hidden" class="postbox-video-field" name="video_id" value="'+ vMData.video.url+'" />');checkVideoStatus(videoStatus,vMData.video.url);},uploadCancelled:function(vmData){resetVideoUpload(con);}}});vidMeUpload.upload();}});}else{investFeed.modal.close('.investfeed-modal#post',function(){swal('Invalid Format',"Unfortunately we cannot process this file format. Please convert your file and try again.",'error');});$(fileInput).replaceWith($(fileInput).clone(true));}}});function checkVideoStatus(elm,vid,delay,iteration){delay=(typeof(delay)=='undefined')?0:delay;iteration=(typeof(iteration)=='undefined')?0:(iteration+ 1);$.ajax({dataType:"json",url:'https://api.vid.me/videoByUrl/'+ vid,success:function(data){if(data.status==true){if(data.video.state=='success'){$(elm).data('video-status','complete').find('.video-status-message').text('');$(elm).removeClass('uploading').addClass('success').find('.video-status-icon').html('<i class="fa fa-video-camera"></i>');}else if(data.video.state=='suspended'){$(elm).data('video-status','rejected').find('.video-status-message').text('Rejected');$(elm).removeClass('uploading').addClass('error').find('.video-status-icon').html('<i class="fa fa-times-circle"></i>');}else{$(elm).find('.video-status-message').text('Processing');if(delay<10){delay=(10*Math.pow(2,10*(iteration/10- 1))+ 2);}else{delay=10;}
setTimeout(function(){checkVideoStatus(elm,vid,delay,iteration);},(delay*1000));}}}});}
function fileAllowed(file){if(window.File&&window.Blob){var extWhitelist=['mpg','mpeg','avi','wmv','mov','flv','ogg','webm','mp4','3gp','mkv','ts','mts','divx'];if(file.type.match('video.*')){return true;}else if($.inArray(file.name.split('.').pop(),extWhitelist)!=-1){return true;}}
return false;}
function checkVideoStatus(elm,vid,delay,iteration){delay=(typeof(delay)=='undefined')?0:delay;iteration=(typeof(iteration)=='undefined')?0:(iteration+ 1);$.ajax({dataType:"json",url:'https://api.vid.me/videoByUrl/'+ vid,success:function(data){if(data.status==true){if(data.video.state=='success'){$(elm).data('video-status','complete').find('.video-status-message').text('');$(elm).addClass('success').find('.video-status-icon').html('<i class="fa fa-video-camera"></i>');}else if(data.video.state=='suspended'){$(elm).data('video-status','rejected').find('.video-status-message').text('Rejected');$(elm).addClass('error').find('.video-status-icon').html('<i class="fa fa-times-circle"></i>');}else{$(elm).find('.video-status-message').text('Processing');if(delay<10){delay=(10*Math.pow(2,10*(iteration/10- 1))+ 2);}else{delay=10;}
setTimeout(function(){checkVideoStatus(elm,vid,delay,iteration);},(delay*1000));}}}});}
$('.post_container').on('click','.postbox-video-status.success, .postbox-video-status.error',function(){var con=$(this).parents('.post_container');swal({title:"Remove Video",text:"Are you sure you want to remove this video from your post, it cannot be recovered?",type:"error",showCancelButton:true,confirmButtonText:'Remove Video'},function(){resetVideoUpload(con);});});$('.post_container').on('click','.postbox-video-status.uploading .video-status',function(){var con=$(this).parents('.post_container');var videoStatus=$(con).find('.postbox-video-status');swal({title:"Cancel Upload",text:"Are you sure you want to cancel your current upload?",type:"error",showCancelButton:true,confirmButtonText:'Remove Video'},function(){vidMeUpload.cancel();});});function resetVideoUpload(con){$(con).find('.postbox-video-status').data('video-status','inactive');$(con).find('.postbox-video-status').find('.video-status-message').html('');$(con).find('.postbox-video-status').find('.video-status-icon').html('');$(con).find('.postbox-upload input').replaceWith($(con).find('.postbox-upload input').clone(true));$(con).find('.postbox-video-status').removeClass('success error').hide();$(con).find('.postbox-actions').show();}
$('.toggle-slider#toggle .opt').click(function(){var position=$(this).data('position');var con=($(this).parents('.post_container').length)?$(this).parents('.post_container'):$(this).parents('.article-options');if($(con).find('.post-slider').val()!=0){toggleSliderCenter($(con));}else{$(con).find('.toggle-slider').removeClass('error');$bull=$(con).find('.opt#bull');$bear=$(con).find('.opt#bear');switch(position){case"bear":$bull.addClass('inactive');$bear.addClass('selected');$bear.text('BEARISH');$(con).find('.slider-handle').animate({left:"5%"},180);$(con).find('.post-slider').val('-100');break;case"bull":$bull.text('BULLISH');$bull.addClass('selected');$bear.addClass('inactive');$(con).find('.slider-handle').animate({left:"95%"},180);$(con).find('.post-slider').val('100');break;}}
return false;});$('.toggle-slider#toggle .slider-handle').click(function(){var con=($(this).parents('.post_container').length)?$(this).parents('.post_container'):$(this).parents('.article-options');toggleSliderCenter($(con));});$('.postbox-symbol').autocomplete({minLength:1,html:true,source:function(request,callback){var trm=request.term.toUpperCase();if((trm.indexOf("$")>0)==false){trm="$"+ request.term;}
$.getJSON(investFeed.base+'hint',{term:trm},callback);},open:function(){$(this).data("uiAutocomplete").menu.element.css('width','auto');}});$('.postbox-symbol').on('input',function(){$(this).val(function(i,v){if(v.replace(/^\s*(?!\$)/,'').length==0)
return;return v.replace(/^\s*(?!\$)/,"$").toUpperCase();});});$('.show_popup').click(function(){if(investFeed.get.registrationStatus()==true){investFeed.modal.open('.investfeed-modal#post',function(){$('.quick-post .ui-textarea').focus();$('.quick-post .post-slider').val('0');$('.quick-post .post-position').prop('checked',false);$('.quick-post .slider-draggable').css({'left':'0px','position':'relative'});});}else{swal("Account Verification","You must confirm your account before you can create a post on investFeed.","error");}
return false;});function toggleSliderCenter(con){var con=$(con);$wrapper=$(con).find('.toggle-slider');$track=$(con).find('.post-position');if($track.is(':checked'))
$track.prop('checked',false);$bull=$(con).find('.opt#bull');$bear=$(con).find('.opt#bear');$bull.text('BULL');$bear.text('BEAR');$bull.removeClass('selected inactive');$bear.removeClass('selected inactive');$(con).find('.slider-handle').css({left:"50%"});$(con).find('.post-slider').val('0');}
function dataURItoBlob(dataURI){var byteString;if(dataURI.split(',')[0].indexOf('base64')>=0){byteString=atob(dataURI.split(',')[1]);}else{byteString=unescape(dataURI.split(',')[1]);}
var mimeString=dataURI.split(',')[0].split(':')[1].split(';')[0];var ia=new Uint8Array(byteString.length);for(var i=0;i<byteString.length;i++){ia[i]=byteString.charCodeAt(i);}
return new Blob([ia],{type:mimeString});}});